<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 7. Move and Neighborhood Selection</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="OptaPlanner User Guide"/><link rel="up" href="index.html" title="OptaPlanner User Guide"/><link rel="prev" href="ch06.html" title="Chapter 6. Optimization Algorithms"/><link rel="next" href="ch08.html" title="Chapter 8. Exhaustive Search"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch06.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch08.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 7. Move and Neighborhood Selection"><div class="titlepage"><div><div><h2 class="title"><a id="moveAndNeighborhoodSelection"/>Chapter 7. <code class="literal">Move</code> and Neighborhood Selection</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch07.html#moveAndNeighborhoodSelectionIntroduction">7.1. <code class="literal">Move</code> and Neighborhood Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="ch07.html#whatIsAMove">7.1.1. What is a <code class="literal">Move</code>?</a></span></dt><dt><span class="section"><a href="ch07.html#whatIsAMoveSelector">7.1.2. What is a <code class="literal">MoveSelector</code>?</a></span></dt><dt><span class="section"><a href="ch07.html#subselectingOfEntitiesValuesAndOtherMoves">7.1.3. Subselecting of Entities, Values and Other Moves</a></span></dt></dl></dd><dt><span class="section"><a href="ch07.html#genericMoveSelectors">7.2. Generic MoveSelectors</a></span></dt><dd><dl><dt><span class="section"><a href="ch07.html#changeMoveSelector">7.2.1. <code class="literal">changeMoveSelector</code></a></span></dt><dt><span class="section"><a href="ch07.html#swapMoveSelector">7.2.2. swapMoveSelector</a></span></dt><dt><span class="section"><a href="ch07.html#pillarChangeMoveSelector">7.2.3. pillarChangeMoveSelector</a></span></dt><dt><span class="section"><a href="ch07.html#pillarSwapMoveSelector">7.2.4. pillarSwapMoveSelector</a></span></dt><dt><span class="section"><a href="ch07.html#tailChainSwapMoveSelector">7.2.5. tailChainSwapMoveSelector or 2-opt (chained variables only)</a></span></dt><dt><span class="section"><a href="ch07.html#subChainChangeMoveSelector">7.2.6. subChainChangeMoveSelector (chained variables only)</a></span></dt><dt><span class="section"><a href="ch07.html#subChainSwapMoveSelector">7.2.7. subChainSwapMoveSelector (chained variables only)</a></span></dt></dl></dd><dt><span class="section"><a href="ch07.html#combiningMultipleMoveSelectors">7.3. Combining Multiple <code class="literal">MoveSelector</code>s</a></span></dt><dd><dl><dt><span class="section"><a href="ch07.html#unionMoveSelector">7.3.1. unionMoveSelector</a></span></dt><dt><span class="section"><a href="ch07.html#cartesianProductMoveSelector">7.3.2. cartesianProductMoveSelector</a></span></dt></dl></dd><dt><span class="section"><a href="ch07.html#entitySelector">7.4. EntitySelector</a></span></dt><dt><span class="section"><a href="ch07.html#valueSelector">7.5. ValueSelector</a></span></dt><dt><span class="section"><a href="ch07.html#generalSelectorFeatures">7.6. General <code class="literal">Selector</code> Features</a></span></dt><dd><dl><dt><span class="section"><a href="ch07.html#cacheType">7.6.1. <code class="literal">CacheType</code>: Create Moves Ahead of Time or Just In Time</a></span></dt><dt><span class="section"><a href="ch07.html#selectionOrder">7.6.2. SelectionOrder: Original, Sorted, Random, Shuffled or Probabilistic</a></span></dt><dt><span class="section"><a href="ch07.html#recommendedCombinationsOfCacheTypeAndSelectionOrder">7.6.3. Recommended Combinations of <code class="literal">CacheType</code> and <code class="literal">SelectionOrder</code></a></span></dt><dt><span class="section"><a href="ch07.html#filteredSelection">7.6.4. Filtered Selection</a></span></dt><dt><span class="section"><a href="ch07.html#sortedSelection">7.6.5. Sorted Selection</a></span></dt><dt><span class="section"><a href="ch07.html#probabilisticSelection">7.6.6. Probabilistic Selection</a></span></dt><dt><span class="section"><a href="ch07.html#limitedSelection">7.6.7. Limited Selection</a></span></dt><dt><span class="section"><a href="ch07.html#mimicSelection">7.6.8. Mimic Selection (Record/Replay)</a></span></dt><dt><span class="section"><a href="ch07.html#nearbySelection">7.6.9. Nearby Selection</a></span></dt></dl></dd><dt><span class="section"><a href="ch07.html#customMoves">7.7. Custom Moves</a></span></dt><dd><dl><dt><span class="section"><a href="ch07.html#whichMoveTypesMightBeMissing">7.7.1. Which Move Types Might be Missing in my Implementation?</a></span></dt><dt><span class="section"><a href="ch07.html#customMovesIntroduction">7.7.2. Custom Moves Introduction</a></span></dt><dt><span class="section"><a href="ch07.html#theInterfaceMove">7.7.3. The Interface <code class="literal">Move</code></a></span></dt><dt><span class="section"><a href="ch07.html#moveListFactory">7.7.4. <code class="literal">MoveListFactory</code>: the Easy Way to Generate Custom Moves</a></span></dt><dt><span class="section"><a href="ch07.html#moveIteratorFactory">7.7.5. <code class="literal">MoveIteratorFactory</code>: Generate Custom Moves Just in Time</a></span></dt></dl></dd></dl></div><div class="section" title="7.1. Move and Neighborhood Introduction"><div class="titlepage"><div><div><h2 class="title"><a id="moveAndNeighborhoodSelectionIntroduction"/>7.1. <code class="literal">Move</code> and Neighborhood Introduction</h2></div></div></div><div class="section" title="7.1.1. What is a Move?"><div class="titlepage"><div><div><h3 class="title"><a id="whatIsAMove"/>7.1.1. What is a <code class="literal">Move</code>?</h3></div></div></div><p>A <code class="literal">Move</code> is a change (or set of changes) from a solution A to a solution B. For example,
      the move below changes queen <code class="literal">C</code> from row <code class="literal">0</code> to row
      <code class="literal">2</code>:</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/singleMoveNQueens04.png"/></div><p>The new solution is called a <span class="emphasis"><em>neighbor</em></span> of the original solution, because it can be
      reached in a single <code class="literal">Move</code>. Although a single move can change multiple queens, the neighbors of a
      solution should always be a very small subset of all possible solutions. For example, on that original solution,
      these are all possible <code class="literal">changeMove</code>'s:</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/possibleMovesNQueens04.png"/></div><p>If we ignore the 4 <code class="literal">changeMove</code>'s that have not impact and are therefore not doable, we can
      see that number of moves is <code class="literal">n * (n - 1) = 12</code>. This is far less than the number of possible
      solutions, which is <code class="literal">n ^ n = 256</code>. As the problem scales out, the number of possible moves
      increases far less than the number of possible solutions.</p><p>Yet, in 4 <code class="literal">changeMove</code>'s or less we can reach any solution. For example we can reach a very
      different solution in 3 <code class="literal">changeMove</code>'s:</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/sequentialMovesNQueens04.png"/></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>There are many other types of moves besides <code class="literal">changeMove</code>'s. Many move types are included
        out-of-the-box, but you can also implement custom moves.</p><p>A <code class="literal">Move</code> can affect multiple entities or even create/delete entities. But it must not
        change the problem facts.</p></div><p>All optimization algorithms use <code class="literal">Move</code>'s to transition from one solution to a neighbor
      solution. Therefore, all the optimization algorithms are confronted with <code class="literal">Move</code> selection: the
      craft of creating and iterating moves efficiently and the art of finding the most promising subset of random moves
      to evaluate first.</p></div><div class="section" title="7.1.2. What is a MoveSelector?"><div class="titlepage"><div><div><h3 class="title"><a id="whatIsAMoveSelector"/>7.1.2. What is a <code class="literal">MoveSelector</code>?</h3></div></div></div><p>A <code class="literal">MoveSelector</code>'s main function is to create <code class="literal">Iterator&lt;Move&gt;</code> when
      needed. An optimization algorithm will iterate through a subset of those moves.</p><p>Here's an example how to configure a <code class="literal">changeMoveSelector</code> for the optimization algorithm
      Local Search:</p><pre><code class="language-xml">  &lt;localSearch&gt;
    &lt;changeMoveSelector/&gt;
    ...
  &lt;/localSearch&gt;</code></pre><p>Out of the box, this works and all properties of the <code class="literal">changeMoveSelector</code> are defaulted
      sensibly (unless that fails fast due to ambiguity). On the other hand, the configuration can be customized
      significantly for specific use cases. For example: you might want to configure a filter to discard pointless
      moves.</p></div><div class="section" title="7.1.3. Subselecting of Entities, Values and Other Moves"><div class="titlepage"><div><div><h3 class="title"><a id="subselectingOfEntitiesValuesAndOtherMoves"/>7.1.3. Subselecting of Entities, Values and Other Moves</h3></div></div></div><p>To create a <code class="literal">Move</code>, a <code class="literal">MoveSelector</code> needs to select 1 or more planning
      entities and/or planning values to move. Just like <code class="literal">MoveSelector</code>s,
      <code class="literal">EntitySelector</code>s and <code class="literal">ValueSelector</code>s need to support a similar feature set
      (such as scalable just-in-time selection). Therefore, they all implement a common interface
      <code class="literal">Selector</code> and they are configured similarly.</p><p>A MoveSelector is often composed out of <code class="literal">EntitySelector</code>s,
      <code class="literal">ValueSelector</code>s or even other <code class="literal">MoveSelector</code>s, which can be configured
      individually if desired:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;valueSelector&gt;
          ...
        &lt;/valueSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre><p>Together, this structure forms a <code class="literal">Selector</code> tree:</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/selectorTree.png"/></div><p>The root of this tree is a <code class="literal">MoveSelector</code> which is injected into the optimization algorithm
      implementation to be (partially) iterated in every step.</p></div></div><div class="section" title="7.2. Generic MoveSelectors"><div class="titlepage"><div><div><h2 class="title"><a id="genericMoveSelectors"/>7.2. Generic MoveSelectors</h2></div></div></div><div class="section" title="7.2.1. changeMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="changeMoveSelector"/>7.2.1. <code class="literal">changeMoveSelector</code></h3></div></div></div><p>For 1 planning variable, the <code class="literal">ChangeMove</code> selects 1 planning entity and 1 planning value
      and assigns the entity's variable to that value.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/changeMove.png"/></div><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;changeMoveSelector/&gt;</code></pre><p>If there are multiple entity classes or multiple planning variables for 1 entity class, a simple
      configuration will automatically unfold into a <a class="link" href="ch07.html#unionMoveSelector" title="7.3.1. unionMoveSelector">union</a> of
      <code class="literal">ChangeMove</code> selectors for every planning variable.</p><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;changeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre><p>A <code class="literal">ChangeMove</code> is the finest grained move.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>Almost every <code class="literal">moveSelector</code> configuration injected into a metaheuristic algorithm should
        include a changeMoveSelector or a custom implementation. This guarantees that every possible
        <code class="literal">Solution</code> can be reached through applying a number of moves in sequence (not taking <a class="link" href="ch05.html#scoreTrap" title="5.4.8. Score Trap">score traps</a> into account). Of course, normally it is unioned with other, more coarse
        grained move selectors.</p></div></div><div class="section" title="7.2.2. swapMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="swapMoveSelector"/>7.2.2. swapMoveSelector</h3></div></div></div><p>The <code class="literal">SwapMove</code> selects 2 different planning entities and swaps the planning values of all
      their planning variables.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/swapMove.png"/></div><p>Although a <code class="literal">SwapMove</code> on a single variable is essentially just 2
      <code class="literal">ChangeMove</code>s, it's often the winning step where the first of the 2
      <code class="literal">ChangeMove</code>s would not be the winning step because it leaves the solution in a state with broken
      hard constraints. For example: swapping the room of 2 lectures doesn't bring the solution in a intermediate state
      where both lectures are in the same room which breaks a hard constraint.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;swapMoveSelector/&gt;</code></pre><p>If there are multiple entity classes, a simple configuration will automatically unfold into a <a class="link" href="ch07.html#unionMoveSelector" title="7.3.1. unionMoveSelector">union</a> of <code class="literal">SwapMove</code> selectors for every entity class.</p><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;swapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;secondaryEntitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/secondaryEntitySelector&gt;
      &lt;variableNameInclude&gt;room&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/swapMoveSelector&gt;</code></pre><p>The <code class="literal">secondaryEntitySelector</code> is rarely needed: if it is not specified, entities from the
      same <code class="literal">entitySelector</code> are swapped.</p><p>If one or more <code class="literal">variableNameInclude</code> properties are specified, not all planning variables
      will be swapped, but only those specified. For example for course scheduling, specifying only
      <code class="literal">variableNameInclude</code> room will make it only swap room, not period.</p></div><div class="section" title="7.2.3. pillarChangeMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="pillarChangeMoveSelector"/>7.2.3. pillarChangeMoveSelector</h3></div></div></div><p>A <span class="emphasis"><em>pillar</em></span> is a set of planning entities which have the same planning value(s) for their
      planning variable(s). The <code class="literal">PillarChangeMove</code> selects 1 entity pillar (or subset of those) and
      changes the value of 1 variable (which is the same for all entities) to another value.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/pillarChangeMove.png"/></div><p>In the example above, queen A and C have the same value (row 0) and are moved to row 2. Also the yellow and
      blue process have the same value (computer Y) and are moved to computer X.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;pillarChangeMoveSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;pillarSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;subPillarEnabled&gt;true&lt;/subPillarEnabled&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
        ...
      &lt;/valueSelector&gt;
    &lt;/pillarSwapMoveSelector&gt;</code></pre><p>A sub pillar is a subset of entities that share the same value(s) for their variable(s). For example if
      queen A, B, C and D are all located on row 0, they are a pillar and <code class="literal">[A, D]</code> is one of the many
      sub pillars. If <code class="literal">subPillarEnabled</code> (defaults to <code class="literal">true</code>) is false, no sub pillars
      are selected. If sub pillars are enabled, the pillar itself is also included and the properties
      <code class="literal">minimumSubPillarSize</code> (defaults to <code class="literal">1</code>) and
      <code class="literal">maximumSubPillarSize</code> (defaults to <code class="literal">infinity</code>) limit the size of the selected
      (sub) pillar.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The number of sub pillars of a pillar is exponential to the size of the pillar. For example a pillar of
        size 32 has <code class="literal">(2^32 - 1)</code> subpillars. Therefore a <code class="literal">pillarSelector</code> only
        supports <a class="link" href="ch07.html#justInTimeRandomSelection" title="7.6.3.1. Just in Time Random Selection (default)">JIT random selection</a> (which is the default).</p></div><p>The other properties are explained in <a class="link" href="ch07.html#changeMoveSelector" title="7.2.1. changeMoveSelector">changeMoveSelector</a>.</p></div><div class="section" title="7.2.4. pillarSwapMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="pillarSwapMoveSelector"/>7.2.4. pillarSwapMoveSelector</h3></div></div></div><p>A <span class="emphasis"><em>pillar</em></span> is a set of planning entities which have the same planning value(s) for their
      planning variable(s). The <code class="literal">PillarSwapMove</code> selects 2 different entity pillars and swaps the
      values of all their variables for all their entities.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/pillarSwapMove.png"/></div><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;pillarSwapMoveSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;pillarSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;subPillarEnabled&gt;true&lt;/subPillarEnabled&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;secondaryPillarSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        ...
      &lt;/secondaryPillarSelector&gt;
      &lt;variableNameInclude&gt;room&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/pillarSwapMoveSelector&gt;</code></pre><p>The <code class="literal">secondaryPillarSelector</code> is rarely needed: if it is not specified, entities from the
      same <code class="literal">pillarSelector</code> are swapped.</p><p>The other properties are explained in <a class="link" href="ch07.html#swapMoveSelector" title="7.2.2. swapMoveSelector">swapMoveSelector</a> and <a class="link" href="ch07.html#pillarChangeMoveSelector" title="7.2.3. pillarChangeMoveSelector">pillarChangeMoveSelector</a>.</p></div><div class="section" title="7.2.5. tailChainSwapMoveSelector or 2-opt (chained variables only)"><div class="titlepage"><div><div><h3 class="title"><a id="tailChainSwapMoveSelector"/>7.2.5. tailChainSwapMoveSelector or 2-opt (chained variables only)</h3></div></div></div><p>A <span class="emphasis"><em>tailChain</em></span> is a set of planning entities with a chained planning variable which form a
      last part of a chain. The <code class="literal">tailChainSwapMove</code> selects a tail chain and swaps it with the tail
      chain of another planning value (in a different or the same anchor chain). If the targeted planning value, doesn't
      have a tail chain, it swaps with nothing (resulting in a change like move). If it occurs within the same anchor
      chain, a partial chain reverse occurs. In academic papers, this is often called a 2-opt move.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;tailChainSwapMoveSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;subChainChangeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/subChainChangeMoveSelector&gt;</code></pre><p>The <code class="literal">entitySelector</code> selects the start of the tail chain that is being moved. The
      valueSelector selects to where that tail chain is moved. If it has a tail chain itself, that is moved to the
      location of the original tail chain. It uses a <code class="literal">valueSelector</code> instead of a
      <code class="literal">secondaryEntitySelector</code> to be able to include all possible 2opt moves (such as moving to the
      end of a tail) and to work correctly with <a class="link" href="ch07.html#nearbySelection" title="7.6.9. Nearby Selection">nearby selection</a> (because of
      asymmetric distances and also swapped entity distance gives an incorrect selection probability).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Although <code class="literal">subChainChangeMoveSelector</code> and <code class="literal">subChainSwapMoveSelector</code>
        include almost every possible <code class="literal">tailChainSwapMove</code>, experiments have shown that focusing on
        <code class="literal">tailChainSwapMove</code>s increases efficiency.</p></div></div><div class="section" title="7.2.6. subChainChangeMoveSelector (chained variables only)"><div class="titlepage"><div><div><h3 class="title"><a id="subChainChangeMoveSelector"/>7.2.6. subChainChangeMoveSelector (chained variables only)</h3></div></div></div><p>A <span class="emphasis"><em>subChain</em></span> is a set of planning entities with a chained planning variable which form
      part of a chain. The <code class="literal">subChainChangeMoveSelector</code> selects a subChain and moves it to another
      place (in a different or the same anchor chain).</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;subChainChangeMoveSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;subChainChangeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;valueSelector&gt;
        &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
        ...
      &lt;/valueSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainChangeMoveSelector&gt;</code></pre><p>The <code class="literal">subChainSelector</code> selects a number of entities, no less than
      <code class="literal">minimumSubChainSize</code> (defaults to <code class="literal">1</code>) and no more than
      <code class="literal">maximumSubChainSize</code> (defaults to <code class="literal">infinity</code>).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>If <code class="literal">minimumSubChainSize</code> is <code class="literal">1</code> (which is the default), this selector
        might select the same move as a <code class="literal">ChangeMoveSelector</code>, at a far lower selection probability
        (because each move <span class="emphasis"><em>type</em></span> has the same selection chance by default (not every move instance)
        and there are far more <code class="literal">SubChainChangeMove</code> instances than <code class="literal">ChangeMove</code>
        instances). However, don't just remove the <code class="literal">ChangeMoveSelector</code>, because experiments show that
        it's good to focus on <code class="literal">ChangeMove</code>s.</p><p>Furthermore, in a <code class="literal">SubChainSwapMoveSelector</code>, setting
        <code class="literal">minimumSubChainSize</code> prevents swapping a subchain of size <code class="literal">1</code> with a subchain
        of at least size <code class="literal">2</code>.</p></div><p>The <code class="literal">selectReversingMoveToo</code> property (defaults to true) enables selecting the reverse of
      every subchain too.</p></div><div class="section" title="7.2.7. subChainSwapMoveSelector (chained variables only)"><div class="titlepage"><div><div><h3 class="title"><a id="subChainSwapMoveSelector"/>7.2.7. subChainSwapMoveSelector (chained variables only)</h3></div></div></div><p>The <code class="literal">subChainSwapMoveSelector</code> selects 2 different subChains and moves them to another
      place in a different or the same anchor chain.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;subChainSwapMoveSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;subChainSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;secondarySubChainSelector&gt;
        &lt;valueSelector&gt;
          &lt;variableName&gt;previousStandstill&lt;/variableName&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/secondarySubChainSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainSwapMoveSelector&gt;</code></pre><p>The <code class="literal">secondarySubChainSelector</code> is rarely needed: if it is not specified, entities from the
      same <code class="literal">subChainSelector</code> are swapped.</p><p>The other properties are explained in <a class="link" href="ch07.html#subChainChangeMoveSelector" title="7.2.6. subChainChangeMoveSelector (chained variables only)">subChainChangeMoveSelector</a>.</p></div></div><div class="section" title="7.3. Combining Multiple MoveSelectors"><div class="titlepage"><div><div><h2 class="title"><a id="combiningMultipleMoveSelectors"/>7.3. Combining Multiple <code class="literal">MoveSelector</code>s</h2></div></div></div><div class="section" title="7.3.1. unionMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="unionMoveSelector"/>7.3.1. unionMoveSelector</h3></div></div></div><p>A <code class="literal">unionMoveSelector</code> selects a <code class="literal">Move</code> by selecting 1 of its
      <code class="literal">MoveSelector</code> children to supply the next <code class="literal">Move</code>.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;...ProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre><p>The <code class="literal">selectorProbabilityWeightFactory</code> determines in <code class="literal">selectionOrder</code>
      <code class="literal">RANDOM</code> how often a <code class="literal">MoveSelector</code> child is selected to supply the next Move.
      By default, each <code class="literal">MoveSelector</code> child has the same chance of being selected.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/selectorProbabilityInUnion.png"/></div><p>Change the <code class="literal">fixedProbabilityWeight</code> of such a child to select it more often. For example,
      the <code class="literal">unionMoveSelector</code> can return a <code class="literal">SwapMove</code> twice as often as a
      <code class="literal">ChangeMove</code>:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;1.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;2.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre><p>The number of possible <code class="literal">ChangeMove</code>s is very different from the number of possible
      <code class="literal">SwapMove</code>s and furthermore it's problem dependent. To give each individual
      <code class="literal">Move</code> the same selection chance (as opposed to each <code class="literal">MoveSelector</code>), use the
      <code class="literal">FairSelectorProbabilityWeightFactory</code>:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;org.optaplanner.core.impl.heuristic.selector.common.decorator.FairSelectorProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre></div><div class="section" title="7.3.2. cartesianProductMoveSelector"><div class="titlepage"><div><div><h3 class="title"><a id="cartesianProductMoveSelector"/>7.3.2. cartesianProductMoveSelector</h3></div></div></div><p>A <code class="literal">cartesianProductMoveSelector</code> selects a new <code class="literal">CompositeMove</code>. It builds
      that <code class="literal">CompositeMove</code> by selecting 1 <code class="literal">Move</code> per <code class="literal">MoveSelector</code>
      child and adding it to the <code class="literal">CompositeMove</code>.</p><p>Simplest configuration:</p><pre><code class="language-xml">    &lt;cartesianProductMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;cartesianProductMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;ignoreEmptyChildIterators&gt;true&lt;/ignoreEmptyChildIterators&gt;
      &lt;changeMoveSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre><p>The <code class="literal">ignoreEmptyChildIterators</code> property (true by default) will ignore every empty
      <code class="literal">childMoveSelector</code> to avoid returning no moves. For example: a cartesian product of
      <code class="literal">changeMoveSelector</code> A and B, for which B is empty (because all it's entities are immovable)
      returns no move if <code class="literal">ignoreEmptyChildIterators</code> is <code class="literal">false</code> and the moves of A if
      <code class="literal">ignoreEmptyChildIterators</code> is <code class="literal">true</code>.</p><p>To enforce that 2 child selectors use the same entity or value efficiently, use <a class="link" href="ch07.html#mimicSelection" title="7.6.8. Mimic Selection (Record/Replay)">mimic selection</a>, not move filtering.</p></div></div><div class="section" title="7.4. EntitySelector"><div class="titlepage"><div><div><h2 class="title"><a id="entitySelector"/>7.4. EntitySelector</h2></div></div></div><p>Simplest configuration:</p><pre><code class="language-xml">      &lt;entitySelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">      &lt;entitySelector&gt;
        ... &lt;!-- Normal selector properties --&gt;
        &lt;entityClass&gt;org.optaplanner.examples.curriculumcourse.domain.Lecture&lt;/entityClass&gt;
      &lt;/entitySelector&gt;</code></pre><p>The <code class="literal">entityClass</code> property is only required if it cannot be deduced automatically because
    there are multiple entity classes.</p></div><div class="section" title="7.5. ValueSelector"><div class="titlepage"><div><div><h2 class="title"><a id="valueSelector"/>7.5. ValueSelector</h2></div></div></div><p>Simplest configuration:</p><pre><code class="language-xml">      &lt;valueSelector/&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">      &lt;valueSelector&gt;
        ... &lt;!-- Normal selector properties --&gt;
        &lt;variableName&gt;room&lt;/variableName&gt;
      &lt;/valueSelector&gt;</code></pre><p>The <code class="literal">variableName</code> property is only required if it cannot be deduced automatically because
    there are multiple variables (for the related entity class).</p><p>In exotic Construction Heuristic configurations, the <code class="literal">entityClass</code> from the
    <code class="literal">EntitySelector</code> sometimes needs to be downcasted, which can be done with the property
    <code class="literal">downcastEntityClass</code>:</p><pre><code class="language-xml">      &lt;valueSelector&gt;
        &lt;downcastEntityClass&gt;...LeadingExam&lt;/downcastEntityClass&gt;
        &lt;variableName&gt;period&lt;/variableName&gt;
      &lt;/valueSelector&gt;</code></pre><p>If a selected entity cannot be downcasted, the <code class="literal">ValueSelector</code> is empty for that
    entity.</p></div><div class="section" title="7.6. General Selector Features"><div class="titlepage"><div><div><h2 class="title"><a id="generalSelectorFeatures"/>7.6. General <code class="literal">Selector</code> Features</h2></div></div></div><div class="section" title="7.6.1. CacheType: Create Moves Ahead of Time or Just In Time"><div class="titlepage"><div><div><h3 class="title"><a id="cacheType"/>7.6.1. <code class="literal">CacheType</code>: Create Moves Ahead of Time or Just In Time</h3></div></div></div><p>A <code class="literal">Selector</code>'s <code class="literal">cacheType</code> determines when a selection (such as a
      <code class="literal">Move</code>, an entity, a value, ...) is created and how long it lives.</p><p>Almost every <code class="literal">Selector</code> supports setting a <code class="literal">cacheType</code>:</p><pre><code class="language-xml">    &lt;changeMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre><p>The following <code class="literal">cacheType</code>s are supported:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">JUST_IN_TIME</code> (default): Not cached. Construct each selection
          (<code class="literal">Move</code>, ...) just before it's used. This scales up well in memory footprint.</p></li><li class="listitem"><p><code class="literal">STEP</code>: Cached. Create each selection (<code class="literal">Move</code>, ...) at the beginning
          of a step and cache them in a list for the remainder of the step. This scales up badly in memory
          footprint.</p></li><li class="listitem"><p><code class="literal">PHASE</code>: Cached. Create each selection (<code class="literal">Move</code>, ...) at the beginning
          of a solver phase and cache them in a list for the remainder of the phase. Some selections cannot be phase
          cached because the list changes every step. This scales up badly in memory footprint, but has a slight
          performance gain.</p></li><li class="listitem"><p><code class="literal">SOLVER</code>: Cached. Create each selection (<code class="literal">Move</code>, ...) at the beginning
          of a <code class="literal">Solver</code> and cache them in a list for the remainder of the <code class="literal">Solver</code>.
          Some selections cannot be solver cached because the list changes every step. This scales up badly in memory
          footprint, but has a slight performance gain.</p></li></ul></div><p>A <code class="literal">cacheType</code> can be set on composite selectors too:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre><p>Nested selectors of a cached selector cannot be configured to be cached themselves, unless it's a higher
      <code class="literal">cacheType</code>. For example: a <code class="literal">STEP</code> cached <code class="literal">unionMoveSelector</code>
      can hold a <code class="literal">PHASE</code> cached <code class="literal">changeMoveSelector</code>, but not a
      <code class="literal">STEP</code> cached <code class="literal">changeMoveSelector</code>.</p></div><div class="section" title="7.6.2. SelectionOrder: Original, Sorted, Random, Shuffled or Probabilistic"><div class="titlepage"><div><div><h3 class="title"><a id="selectionOrder"/>7.6.2. SelectionOrder: Original, Sorted, Random, Shuffled or Probabilistic</h3></div></div></div><p>A <code class="literal">Selector</code>'s <code class="literal">selectionOrder</code> determines the order in which the
      selections (such as <code class="literal">Move</code>s, entities, values, ...) are iterated. An optimization algorithm will
      usually only iterate through a subset of its <code class="literal">MoveSelector</code>'s selections, starting from the
      start, so the <code class="literal">selectionOrder</code> is critical to decide which <code class="literal">Move</code>s are actually
      evaluated.</p><p>Almost every <code class="literal">Selector</code> supports setting a <code class="literal">selectionOrder</code>:</p><pre><code class="language-xml">    &lt;changeMoveSelector&gt;
      ...
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre><p>The following <code class="literal">selectionOrder</code>s are supported:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">ORIGINAL</code>: Select the selections (<code class="literal">Move</code>s, entities, values, ...) in
          default order. Each selection will be selected only once.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For example: A0, A1, A2, A3, ..., B0, B1, B2, B3, ..., C0, C1, C2, C3, ...</p></li></ul></div></li><li class="listitem"><p>SORTED: Select the selections (<code class="literal">Move</code>s, entities, values, ...) in sorted order. Each
          selection will be selected only once. Requires <code class="literal">cacheType &gt;= STEP</code>. Mostly used on an
          <code class="literal">entitySelector</code> or <code class="literal">valueSelector</code> for construction heuristics. See <a class="link" href="ch07.html#sortedSelection" title="7.6.5. Sorted Selection">sorted selection</a>.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For example: A0, B0, C0, ..., A2, B2, C2, ..., A1, B1, C1, ...</p></li></ul></div></li><li class="listitem"><p>RANDOM (default): Select the selections (<code class="literal">Move</code>s, entities, values, ...) in
          non-shuffled random order. A selection might be selected multiple times. This scales up well in performance
          because it does not require caching.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For example: C2, A3, B1, C2, A0, C0, ...</p></li></ul></div></li><li class="listitem"><p>SHUFFLED: Select the selections (<code class="literal">Move</code>s, entities, values, ...) in shuffled random
          order. Each selection will be selected only once. Requires <code class="literal">cacheType &gt;= STEP</code>. This
          scales up badly in performance, not just because it requires caching, but also because a random number is
          generated for each element, even if it's not selected (which is the grand majority when scaling up).</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For example: C2, A3, B1, A0, C0, ...</p></li></ul></div></li><li class="listitem"><p>PROBABILISTIC: Select the selections (<code class="literal">Move</code>s, entities, values, ...) in random order,
          based on the selection probability of each element. A selection with a higher probability has a higher chance
          to be selected than elements with a lower probability. A selection might be selected multiple times. Requires
          <code class="literal">cacheType &gt;= STEP</code>. Mostly used on an <code class="literal">entitySelector</code> or
          <code class="literal">valueSelector</code>. See <a class="link" href="ch07.html#probabilisticSelection" title="7.6.6. Probabilistic Selection">probabilistic
          selection</a>.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For example: B1, B1, A1, B2, B1, C2, B1, B1, ...</p></li></ul></div></li></ul></div><p>A <code class="literal">selectionOrder</code> can be set on composite selectors too.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>When a <code class="literal">Selector</code> is cached, all of its nested <code class="literal">Selector</code>s will
        naturally default to <code class="literal">selectionOrder</code> <code class="literal">ORIGINAL</code>. Avoid overwriting the
        <code class="literal">selectionOrder</code> of those nested <code class="literal">Selector</code>s.</p></div></div><div class="section" title="7.6.3. Recommended Combinations of CacheType and SelectionOrder"><div class="titlepage"><div><div><h3 class="title"><a id="recommendedCombinationsOfCacheTypeAndSelectionOrder"/>7.6.3. Recommended Combinations of <code class="literal">CacheType</code> and <code class="literal">SelectionOrder</code></h3></div></div></div><div class="section" title="7.6.3.1. Just in Time Random Selection (default)"><div class="titlepage"><div><div><h4 class="title"><a id="justInTimeRandomSelection"/>7.6.3.1. Just in Time Random Selection (default)</h4></div></div></div><p>This combination is great for big use cases (10 000 entities or more), as it scales up well in memory
        footprint and performance. Other combinations are often not even viable on such sizes. It works for smaller use
        cases too, so it's a good way to start out. It's the default, so this explicit configuration of
        <code class="literal">cacheType</code> and <code class="literal">selectionOrder</code> is actually obsolete:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;JUST_IN_TIME&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre><p>Here's how it works. When <code class="literal">Iterator&lt;Move&gt;.next()</code> is called, a child
        <code class="literal">MoveSelector</code> is randomly selected (1), which creates a random <code class="literal">Move</code> (2, 3,
        4) and is then returned (5):</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/jitRandomSelection.png"/></div><p>Notice that <span class="bold"><strong>it never creates a list of <code class="literal">Move</code>s</strong></span> and it
        generates random numbers only for <code class="literal">Move</code>s that are actually selected.</p></div><div class="section" title="7.6.3.2. Cached Shuffled Selection"><div class="titlepage"><div><div><h4 class="title"><a id="cachedShuffledSelection"/>7.6.3.2. Cached Shuffled Selection</h4></div></div></div><p>This combination often wins for small and medium use cases (5000 entities or less). Beyond that size, it
        scales up badly in memory footprint and performance.</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre><p>Here's how it works: At the start of the phase (or step depending on the <code class="literal">cacheType</code>),
        all moves are created (1) and cached (2). When <code class="literal">MoveSelector.iterator()</code> is called, the moves
        are shuffled (3). When <code class="literal">Iterator&lt;Move&gt;.next()</code> is called, the next element in the
        shuffled list is returned (4):</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/cachedShuffledSelection.png"/></div><p>Notice that <span class="bold"><strong>each <code class="literal">Move</code> will only be selected once</strong></span>, even
        though they are selected in random order.</p><p>Use cacheType PHASE if none of the (possibly nested) Selectors require <code class="literal">STEP</code>. Otherwise,
        do something like this:</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;STEP&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector/&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/swapMoveSelector&gt;
      &lt;pillarSwapMoveSelector/&gt;&lt;!-- Does not support cacheType PHASE --&gt;
    &lt;/unionMoveSelector&gt;</code></pre></div><div class="section" title="7.6.3.3. Cached Random Selection"><div class="titlepage"><div><div><h4 class="title"><a id="cachedRandomSelection"/>7.6.3.3. Cached Random Selection</h4></div></div></div><p>This combination is often a worthy competitor for medium use cases, especially with fast stepping
        optimization algorithms (such as Simulated Annealing). Unlike cached shuffled selection, it doesn't waste time
        shuffling the moves list at the beginning of every step.</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre></div></div><div class="section" title="7.6.4. Filtered Selection"><div class="titlepage"><div><div><h3 class="title"><a id="filteredSelection"/>7.6.4. Filtered Selection</h3></div></div></div><p>There can be certain moves that you don't want to select, because:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The move is pointless and would only waste CPU time. For example, swapping 2 lectures of the same course
          will result in the same score and the same schedule because all lectures of 1 course are interchangeable (same
          teacher, same students, same topic).</p></li><li class="listitem"><p>Doing the move would break <a class="link" href="ch05.html#buildInHardConstraint" title="5.4.6. Built-in Hard Constraint">a built-in hard constraint</a>, so
          the solution would be infeasible but the score function doesn't check built-in hard constraints (for
          performance gain). For example, don't change a gym lecture to a room which is not a gym room.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Any built-in hard constraint must probably be filtered on every move type of every solver phase. For
            example if it's filters the change move of Local Search, it must also filter the swap move that swaps the
            room of a gym lecture with another lecture for which the other lecture's original room isn't a gym room.
            Furthermore, it must also filter the change moves of the Construction Heuristics (which requires an advanced
            configuration).</p></div></li></ul></div><p>Filtered selection can happen on any Selector in the selector tree, including any
      <code class="literal">MoveSelector</code>, <code class="literal">EntitySelector</code> or <code class="literal">ValueSelector</code>. It works
      with any <code class="literal">cacheType</code> and <code class="literal">selectionOrder</code>.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/filteredSelection.png"/></div><p>Filtering uses the interface <code class="literal">SelectionFilter</code>:</p><pre><code class="language-java">public interface SelectionFilter&lt;T&gt; {

    boolean accept(ScoreDirector scoreDirector, T selection);

}</code></pre><p>Implement the <code class="literal">accept</code> method to return <code class="literal">false</code> on a discarded
      <code class="literal">selection</code>. Unaccepted moves will not be selected and will therefore never have their
      <code class="literal">doMove</code> method called.</p><pre><code class="language-java">public class DifferentCourseSwapMoveFilter implements SelectionFilter&lt;SwapMove&gt; {

    public boolean accept(ScoreDirector scoreDirector, SwapMove move) {
        Lecture leftLecture = (Lecture) move.getLeftEntity();
        Lecture rightLecture = (Lecture) move.getRightEntity();
        return !leftLecture.getCourse().equals(rightLecture.getCourse());
    }

}</code></pre><p>Apply the filter on the lowest level possible. In most cases, you'll need to know both the entity and the
      value involved and you'll have to apply a <code class="literal">filterClass</code> on the
      <code class="literal">moveSelector</code>:</p><pre><code class="language-xml">    &lt;swapMoveSelector&gt;
      &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.DifferentCourseSwapMoveFilter&lt;/filterClass&gt;
    &lt;/swapMoveSelector&gt;</code></pre><p>But if possible, apply it on a lower levels, such as a <code class="literal">filterClass</code> on the
      <code class="literal">entitySelector</code> or <code class="literal">valueSelector</code>:</p><pre><code class="language-xml">    &lt;changeMoveSelector&gt;
      &lt;entitySelector&gt;
        &lt;filterClass&gt;...EntityFilter&lt;/filterClass&gt;
      &lt;/entitySelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre><p>You can configure multiple <code class="literal">filterClass</code> elements on a single selector.</p></div><div class="section" title="7.6.5. Sorted Selection"><div class="titlepage"><div><div><h3 class="title"><a id="sortedSelection"/>7.6.5. Sorted Selection</h3></div></div></div><p>Sorted selection can happen on any Selector in the selector tree, including any
      <code class="literal">MoveSelector</code>, <code class="literal">EntitySelector</code> or <code class="literal">ValueSelector</code>. It does
      not work with <code class="literal">cacheType</code> <code class="literal">JUST_IN_TIME</code> and it only works with
      <code class="literal">selectionOrder SORTED</code>.</p><p>It's mostly used in construction heuristics.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>If the chosen construction heuristic implies sorting, for example <code class="literal">FIRST_FIT_DECREASING</code>
        implies that the <code class="literal">EntitySelector</code> is sorted, there is no need to explicitly configure a
        <code class="literal">Selector</code> with sorting. If you do explicitly configure the <code class="literal">Selector</code>, it
        overwrites the default settings of that construction heuristic.</p></div><div class="section" title="7.6.5.1. Sorted Selection by SorterManner"><div class="titlepage"><div><div><h4 class="title"><a id="sortedSelectionBySorterManner"/>7.6.5.1. Sorted Selection by <code class="literal">SorterManner</code></h4></div></div></div><p>Some <code class="literal">Selector</code> types implement a <code class="literal">SorterManner</code> out of the box:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">EntitySelector</code> supports:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">DECREASING_DIFFICULTY</code>: Sorts the planning entities according to decreasing
                <a class="link" href="ch04.html#planningEntityDifficulty" title="4.3.3.2. Planning Entity Difficulty">planning entity difficulty</a>. Requires that planning
                entity difficulty is annotated on the domain model.</p><pre><code class="language-xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
    &lt;/entitySelector&gt;</code></pre></li></ul></div></li><li class="listitem"><p><code class="literal">ValueSelector</code> supports:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">INCREASING_STRENGTH</code>: Sorts the planning values according to increasing <a class="link" href="ch04.html#planningValueStrength" title="4.3.5.3. Planning Value Strength">planning value strength</a>. Requires that planning value strength is
                annotated on the domain model.</p><pre><code class="language-xml">    &lt;valueSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
    &lt;/valueSelector&gt;</code></pre></li></ul></div></li></ul></div></div><div class="section" title="7.6.5.2. Sorted Selection by Comparator"><div class="titlepage"><div><div><h4 class="title"><a id="sortedSelectionByComparator"/>7.6.5.2. Sorted Selection by <code class="literal">Comparator</code></h4></div></div></div><p>An easy way to sort a <code class="literal">Selector</code> is with a plain old
        <code class="literal">Comparator</code>:</p><pre><code class="language-java">public class CloudProcessDifficultyComparator implements Comparator&lt;CloudProcess&gt; {

    public int compare(CloudProcess a, CloudProcess b) {
        return new CompareToBuilder()
                .append(a.getRequiredMultiplicand(), b.getRequiredMultiplicand())
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre><p>You 'll also need to configure it (unless it's annotated on the domain model and automatically applied by
        the optimization algorithm):</p><pre><code class="language-xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterComparatorClass&gt;...CloudProcessDifficultyComparator&lt;/sorterComparatorClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre></div><div class="section" title="7.6.5.3. Sorted Selection by SelectionSorterWeightFactory"><div class="titlepage"><div><div><h4 class="title"><a id="sortedSelectionBySelectionSorterWeightFactory"/>7.6.5.3. Sorted Selection by <code class="literal">SelectionSorterWeightFactory</code></h4></div></div></div><p>If you need the entire <code class="literal">Solution</code> to sort a <code class="literal">Selector</code>, use a
        <code class="literal">SelectionSorterWeightFactory</code> instead:</p><pre><code class="language-java">public interface SelectionSorterWeightFactory&lt;Sol extends Solution, T&gt; {

    Comparable createSorterWeight(Sol solution, T selection);

}</code></pre><pre><code class="language-java">public class QueenDifficultyWeightFactory implements SelectionSorterWeightFactory&lt;NQueens, Queen&gt; {

    public Comparable createSorterWeight(NQueens nQueens, Queen queen) {
        int distanceFromMiddle = calculateDistanceFromMiddle(nQueens.getN(), queen.getColumnIndex());
        return new QueenDifficultyWeight(queen, distanceFromMiddle);
    }

    // ...

    public static class QueenDifficultyWeight implements Comparable&lt;QueenDifficultyWeight&gt; {

        private final Queen queen;
        private final int distanceFromMiddle;

        public QueenDifficultyWeight(Queen queen, int distanceFromMiddle) {
            this.queen = queen;
            this.distanceFromMiddle = distanceFromMiddle;
        }

        public int compareTo(QueenDifficultyWeight other) {
            return new CompareToBuilder()
                    // The more difficult queens have a lower distance to the middle
                    .append(other.distanceFromMiddle, distanceFromMiddle) // Decreasing
                    // Tie breaker
                    .append(queen.getColumnIndex(), other.queen.getColumnIndex())
                    .toComparison();
        }

    }

}</code></pre><p>You 'll also need to configure it (unless it's annotated on the domain model and automatically applied by
        the optimization algorithm):</p><pre><code class="language-xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterWeightFactoryClass&gt;...QueenDifficultyWeightFactory&lt;/sorterWeightFactoryClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre></div><div class="section" title="7.6.5.4. Sorted Selection by SelectionSorter"><div class="titlepage"><div><div><h4 class="title"><a id="sortedSelectionBySelectionSorter"/>7.6.5.4. Sorted Selection by <code class="literal">SelectionSorter</code></h4></div></div></div><p>Alternatively, you can also use the interface <code class="literal">SelectionSorter</code> directly:</p><pre><code class="language-java">public interface SelectionSorter&lt;T&gt; {

    void sort(ScoreDirector scoreDirector, List&lt;T&gt; selectionList);

}</code></pre><pre><code class="language-xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterClass&gt;...MyEntitySorter&lt;/sorterClass&gt;
    &lt;/entitySelector&gt;</code></pre></div></div><div class="section" title="7.6.6. Probabilistic Selection"><div class="titlepage"><div><div><h3 class="title"><a id="probabilisticSelection"/>7.6.6. Probabilistic Selection</h3></div></div></div><p>Probabilistic selection can happen on any Selector in the selector tree, including any
      <code class="literal">MoveSelector</code>, <code class="literal">EntitySelector</code> or <code class="literal">ValueSelector</code>. It does
      not work with <code class="literal">cacheType</code> <code class="literal">JUST_IN_TIME</code> and it only works with
      <code class="literal">selectionOrder PROBABILISTIC</code>.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/probabilisticSelection.png"/></div><p>Each selection has a <code class="literal">probabilityWeight</code>, which determines the chance that selection will
      be selected:</p><pre><code class="language-java">public interface SelectionProbabilityWeightFactory&lt;T&gt; {

    double createProbabilityWeight(ScoreDirector scoreDirector, T selection);

}</code></pre><pre><code class="language-xml">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;PROBABILISTIC&lt;/selectionOrder&gt;
      &lt;probabilityWeightFactoryClass&gt;...MyEntityProbabilityWeightFactoryClass&lt;/probabilityWeightFactoryClass&gt;
    &lt;/entitySelector&gt;</code></pre><p>For example, if there are 3 entities: process A (probabilityWeight 2.0), process B (probabilityWeight 0.5)
      and process C (probabilityWeight 0.5), then process A will be selected 4 times more than B and C.</p></div><div class="section" title="7.6.7. Limited Selection"><div class="titlepage"><div><div><h3 class="title"><a id="limitedSelection"/>7.6.7. Limited Selection</h3></div></div></div><p>Selecting all possible moves sometimes does not scale well enough, especially for construction heuristics
      (which don't support <a class="link" href="ch10.html#acceptedCountLimit" title="10.2.4.1. Accepted Count Limit">acceptedCountLimit</a>).</p><p>To limit the number of selected selection per step, apply a <code class="literal">selectedCountLimit</code> on the
      selector:</p><pre><code class="language-xml">    &lt;changeMoveSelector&gt;
      &lt;selectedCountLimit&gt;100&lt;/selectedCountLimit&gt;
    &lt;/changeMoveSelector&gt;</code></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>To scale Local Search, setting <a class="link" href="ch10.html#acceptedCountLimit" title="10.2.4.1. Accepted Count Limit">acceptedCountLimit</a> is usually
        better than using <code class="literal">selectedCountLimit</code>.</p></div></div><div class="section" title="7.6.8. Mimic Selection (Record/Replay)"><div class="titlepage"><div><div><h3 class="title"><a id="mimicSelection"/>7.6.8. Mimic Selection (Record/Replay)</h3></div></div></div><p>During mimic selection, 1 normal selector records its selection and 1 or multiple other special selectors
      replay that selection. The recording selector acts as a normal selector and supports all other configuration
      properties. A replaying selector mimics the recording selection and support no other configuration
      properties.</p><p>The recording selector needs an <code class="literal">id</code>. A replaying selector must reference a recorder's id
      with a <code class="literal">mimicSelectorRef</code>:</p><pre><code class="language-xml">      &lt;cartesianProductMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector id="entitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;period&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector mimicSelectorRef="entitySelector"/&gt;
          &lt;valueSelector&gt;
            &lt;variableName&gt;room&lt;/variableName&gt;
          &lt;/valueSelector&gt;
        &lt;/changeMoveSelector&gt;
      &lt;/cartesianProductMoveSelector&gt;</code></pre><p>Mimic selection is useful to create <a class="link" href="ch07.html#cartesianProductMoveSelector" title="7.3.2. cartesianProductMoveSelector">a composite move</a>
      from 2 moves that affect the same entity.</p></div><div class="section" title="7.6.9. Nearby Selection"><div class="titlepage"><div><div><h3 class="title"><a id="nearbySelection"/>7.6.9. Nearby Selection</h3></div></div></div><p>In some use cases (such as TSP and VRP, but also in non-chained variable cases), changing entities to nearby
      values or swapping nearby entities can <span class="bold"><strong>heavily increase scalability</strong></span> and improve
      solution quality.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/nearbySelectionMotivation.png"/></div><p>Nearby selection increases the probability of selecting an entity or value which is nearby to the first
      entity being moved in that move.</p><div class="mediaobject"><img src="images/Chapter-Move_and_neighborhood_selection/nearbySelectionRandomDistribution.png"/></div><p>The distance between 2 entities or values is domain specific. Therefore, implement the
      <code class="literal">NearbyDistanceMeter</code> interface:</p><pre><code class="language-java">public interface NearbyDistanceMeter&lt;O, D&gt; {

    double getNearbyDistance(O origin, D destination);

}</code></pre><p>It returns a <code class="literal">double</code> which represents the distance:</p><pre><code class="language-java">public class CustomerNearbyDistanceMeter implements NearbyDistanceMeter&lt;Customer, Standstill&gt; {

    public double getNearbyDistance(Customer origin, Standstill destination) {
        return origin.getDistanceTo(destination);
    }

}</code></pre><p>To configure nearby selection, add a <code class="literal">nearbySelection</code> element in the
      <code class="literal">entitySelector</code> or <code class="literal">valueSelector</code> and use <a class="link" href="ch07.html#mimicSelection" title="7.6.8. Mimic Selection (Record/Replay)">mimic
      selection</a> to specify which entity should be near by the selection.</p><pre><code class="language-xml">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector id="entitySelector1"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector1"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;entitySelector id="entitySelector2"/&gt;
        &lt;secondaryEntitySelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector2"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/secondaryEntitySelector&gt;
      &lt;/swapMoveSelector&gt;
      &lt;tailChainSwapMoveSelector&gt;
        &lt;entitySelector id="entitySelector3"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector3"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/tailChainSwapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre><p>A <code class="literal">distributionSizeMaximum</code> parameter should not be 1 because if the nearest is already the
      planning value of the current entity, then the only move that is selectable is not doable.</p><p>To allow every element to be selected, regardless of the number of entities, only set the distribution type
      (so without a <code class="literal">distributionSizeMaximum</code> parameter):</p><pre><code class="language-xml">  &lt;nearbySelection&gt;
    &lt;nearbySelectionDistributionType&gt;PARABOLIC_DISTRIBUTION&lt;/nearbySelectionDistributionType&gt;
  &lt;/nearbySelection&gt;</code></pre><p>The following <code class="literal">NearbySelectionDistributionType</code>s are supported:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">BLOCK_DISTRIBUTION</code>: Only the n nearest are selected, with an equal probability. For
          example, select the 20 nearest:</p><pre><code class="language-xml">  &lt;nearbySelection&gt;
    &lt;blockDistributionSizeMaximum&gt;20&lt;/blockDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre></li><li class="listitem"><p><code class="literal">LINEAR_DISTRIBUTION</code>: Nearest elements are selected with a higher probability. The
          probability decreases linearly.</p><pre><code class="language-xml">  &lt;nearbySelection&gt;
    &lt;linearDistributionSizeMaximum&gt;40&lt;/linearDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre></li><li class="listitem"><p><code class="literal">PARABOLIC_DISTRIBUTION</code> (recommended): Nearest elements are selected with a higher
          probability.</p><pre><code class="language-xml">  &lt;nearbySelection&gt;
    &lt;parabolicDistributionSizeMaximum&gt;80&lt;/parabolicDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre></li><li class="listitem"><p><code class="literal">BETA_DISTRIBUTION</code>: Selection according to a beta distribution. Slows down the solver
          significantly.</p><pre><code class="language-xml">  &lt;nearbySelection&gt;
    &lt;betaDistributionAlpha&gt;1&lt;/betaDistributionAlpha&gt;
    &lt;betaDistributionBeta&gt;5&lt;/betaDistributionBeta&gt;
  &lt;/nearbySelection&gt;</code></pre></li></ul></div><p>As always, use the <a class="link" href="ch14.html" title="Chapter 14. Benchmarking And Tweaking">Benchmarker</a> to tweak values if desired.</p></div></div><div class="section" title="7.7. Custom Moves"><div class="titlepage"><div><div><h2 class="title"><a id="customMoves"/>7.7. Custom Moves</h2></div></div></div><div class="section" title="7.7.1. Which Move Types Might be Missing in my Implementation?"><div class="titlepage"><div><div><h3 class="title"><a id="whichMoveTypesMightBeMissing"/>7.7.1. Which Move Types Might be Missing in my Implementation?</h3></div></div></div><p>To determine which move types might be missing in your implementation, run a <a class="link" href="ch14.html" title="Chapter 14. Benchmarking And Tweaking">Benchmarker</a> <span class="emphasis"><em>for a short amount of time</em></span> and <a class="link" href="ch14.html#writeTheOutputSolutionOfBenchmarkRuns" title="14.2.6. Write The Output Solution Of Benchmark Runs">configure it to write the best solutions to disk</a>. Take a
      look at such a best solution: it will likely be a local optima. Try to figure out if there's a move that could get
      out of that local optima faster.</p><p>If you find one, implement that coarse-grained move, mix it with the existing moves and benchmark it against
      the previous configurations to see if you want to keep it.</p></div><div class="section" title="7.7.2. Custom Moves Introduction"><div class="titlepage"><div><div><h3 class="title"><a id="customMovesIntroduction"/>7.7.2. Custom Moves Introduction</h3></div></div></div><p>Instead of reusing the generic <code class="literal">Move</code>s (such as <code class="literal">ChangeMove</code>) you can also
      implement your own <code class="literal">Move</code>s. Generic and custom <code class="literal">MoveSelector</code>s can be combined
      as desired.</p><p>A custom <code class="literal">Move</code> can be tailored to work to the advantage of your constraints. For example,
      in examination scheduling, changing the period of an exam A also changes the period of all the exams that need to
      coincide with exam A.</p><p>A custom <code class="literal">Move</code> is also slightly faster than a generic <code class="literal">Move</code>. However,
      it's far more work to implement and much harder to avoid bugs. After implementing a custom
      <code class="literal">Move</code>, make sure to turn on <code class="literal">environmentMode</code> <code class="literal">FULL_ASSERT</code> to
      check for score corruptions.</p></div><div class="section" title="7.7.3. The Interface Move"><div class="titlepage"><div><div><h3 class="title"><a id="theInterfaceMove"/>7.7.3. The Interface <code class="literal">Move</code></h3></div></div></div><p>Your custom moves must implement the <code class="literal">Move</code> interface:</p><pre><code class="language-java">public interface Move {

    boolean isMoveDoable(ScoreDirector scoreDirector);

    Move createUndoMove(ScoreDirector scoreDirector);
    void doMove(ScoreDirector scoreDirector);

    Collection&lt;? extends Object&gt; getPlanningEntities();
    Collection&lt;? extends Object&gt; getPlanningValues();

}</code></pre><p>Let's take a look at the <code class="literal">Move</code> implementation for 4 queens which moves a queen to a
      different row:</p><pre><code class="language-java">public class RowChangeMove extends AbstractMove {

    private Queen queen;
    private Row toRow;

    public RowChangeMove(Queen queen, Row toRow) {
        this.queen = queen;
        this.toRow = toRow;
    }

    // ... see below

}</code></pre><p>An instance of <code class="literal">RowChangeMove</code> moves a queen from its current row to a different
      row.</p><p>Planner calls the <code class="literal">doMove(ScoreDirector)</code> method to do a move, which calls
      <code class="literal">doMoveOnGenuineVariables(ScoreDirector)</code>. The <code class="literal">Move</code> implementation must notify
      the <code class="literal">ScoreDirector</code> of any changes it makes to planning entity's variables:</p><pre><code class="language-java">    public void doMoveOnGenuineVariables(ScoreDirector scoreDirector) {
        scoreDirector.beforeVariableChanged(queen, "row"); // before changes are made to the queen.row
        queen.setRow(toRow);
        scoreDirector.afterVariableChanged(queen, "row"); // after changes are made to the queen.row
    }</code></pre><p>You need to call the <code class="literal">scoreDirector.beforeVariableChanged(Object, String)</code> and
      <code class="literal">scoreDirector.afterVariableChanged(Object, String)</code> methods directly before and after modifying
      the entity.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>You can alter multiple entities in a single move and effectively create a big move (also known as a
        coarse-grained move).</p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Warning</h2><p>A <code class="literal">Move</code> can only change/add/remove planning entities, it must not change any of the
        problem facts.</p></div><p>Planner automatically filters out <span class="emphasis"><em>non doable moves</em></span> by calling the
      <code class="literal">isMoveDoable(ScoreDirector)</code> method on a move. A <span class="emphasis"><em>non doable move</em></span> is:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A move that changes nothing on the current solution. For example, moving queen B0 to row 0 is not
          doable, because it is already there.</p></li><li class="listitem"><p>A move that is impossible to do on the current solution. For example, moving queen B0 to row 10 is not
          doable because it would move it outside the board limits.</p></li></ul></div><p>In the n queens example, a move which moves the queen from its current row to the same row isn't
      doable:</p><pre><code class="language-java">    public boolean isMoveDoable(ScoreDirector scoreDirector) {
        return !ObjectUtils.equals(queen.getRow(), toRow);
    }</code></pre><p>Because we won't generate a move which can move a queen outside the board limits, we don't need to check it.
      A move that is currently not doable could become doable on the working <code class="literal">Solution</code> of a later
      step.</p><p>Each move has an <span class="emphasis"><em>undo move</em></span>: a move (normally of the same type) which does the exact
      opposite. In the example above the undo move of <span class="emphasis"><em>C0 to C2</em></span> would be the move <span class="emphasis"><em>C2 to
      C0</em></span>. An undo move is created from a <code class="literal">Move</code>, before the <code class="literal">Move</code> has been
      done on the current solution.</p><pre><code class="language-java">    public Move createUndoMove(ScoreDirector scoreDirector) {
        return new RowChangeMove(queen, queen.getRow());
    }</code></pre><p>Notice that if C0 would have already been moved to C2, the undo move would create the move <span class="emphasis"><em>C2 to
      C2</em></span>, instead of the move <span class="emphasis"><em>C2 to C0</em></span>.</p><p>A solver phase might do and undo the same <code class="literal">Move</code> more than once. In fact, many solver
      phases will iteratively do and undo a number of moves to evaluate them, before selecting one of those and doing
      that move again (without undoing it this time).</p><p>A <code class="literal">Move</code> must implement the <code class="literal">getPlanningEntities()</code> and
      <code class="literal">getPlanningValues()</code> methods. They are used by entity tabu and value tabu respectively. When
      they are called, the <code class="literal">Move</code> has already been done.</p><pre><code class="language-java">    public List&lt;? extends Object&gt; getPlanningEntities() {
        return Collections.singletonList(queen);
    }

    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Collections.singletonList(toRow);
    }</code></pre><p>If your <code class="literal">Move</code> changes multiple planning entities, return all of them in
      <code class="literal">getPlanningEntities()</code> and return all their values (to which they are changing) in
      <code class="literal">getPlanningValues()</code>.</p><pre><code class="language-java">    public Collection&lt;? extends Object&gt; getPlanningEntities() {
        return Arrays.asList(leftCloudProcess, rightCloudProcess);
    }

    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Arrays.asList(leftCloudProcess.getComputer(), rightCloudProcess.getComputer());
    }</code></pre><p>A <code class="literal">Move</code> must implement the <code class="literal">equals()</code> and <code class="literal">hashCode()</code>
      methods. 2 moves which make the same change on a solution, should be equal.</p><pre><code class="language-java">    public boolean equals(Object o) {
        if (this == o) {
            return true;
        } else if (o instanceof RowChangeMove) {
            RowChangeMove other = (RowChangeMove) o;
            return new EqualsBuilder()
                    .append(queen, other.queen)
                    .append(toRow, other.toRow)
                    .isEquals();
        } else {
            return false;
        }
    }

    public int hashCode() {
        return new HashCodeBuilder()
                .append(queen)
                .append(toRow)
                .toHashCode();
    }</code></pre><p>Notice that it checks if the other move is an instance of the same move type. This
      <code class="literal">instanceof</code> check is important because a move will be compared to a move with another move type
      if you're using more than 1 move type.</p><p>Implement the <code class="literal">toString()</code> method to keep Planner's logs readable:</p><pre><code class="language-java">    public String toString() {
        return queen + " {" + queen.getRow() + " -&gt; " + toRow + "}";
    }</code></pre><p>Now that we can implement a single custom <code class="literal">Move</code>, let's take a look at generating such
      custom moves.</p></div><div class="section" title="7.7.4. MoveListFactory: the Easy Way to Generate Custom Moves"><div class="titlepage"><div><div><h3 class="title"><a id="moveListFactory"/>7.7.4. <code class="literal">MoveListFactory</code>: the Easy Way to Generate Custom Moves</h3></div></div></div><p>The easiest way to generate custom moves is by implementing the interface
      <code class="literal">MoveListFactory</code>:</p><pre><code class="language-java">public interface MoveListFactory&lt;S extends Solution&gt; {

    List&lt;Move&gt; createMoveList(S solution);

}</code></pre><p>For example:</p><pre><code class="language-java">public class RowChangeMoveFactory implements MoveListFactory&lt;NQueens&gt; {

    public List&lt;Move&gt; createMoveList(NQueens nQueens) {
        List&lt;Move&gt; moveList = new ArrayList&lt;Move&gt;();
        for (Queen queen : nQueens.getQueenList()) {
            for (Row toRow : nQueens.getRowList()) {
                moveList.add(new RowChangeMove(queen, toRow));
            }
        }
        return moveList;
    }

}</code></pre><p>Simple configuration (which can be nested in a <code class="literal">unionMoveSelector</code> just like any other
      <code class="literal">MoveSelector</code>):</p><pre><code class="language-xml">    &lt;moveListFactory&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.nqueens.solver.move.factory.RowChangeMoveFactory&lt;/moveListFactoryClass&gt;
    &lt;/moveListFactory&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;moveListFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.nqueens.solver.move.factory.RowChangeMoveFactory&lt;/moveListFactoryClass&gt;
    &lt;/moveListFactory&gt;</code></pre><p>Because the <code class="literal">MoveListFactory</code> generates all moves at once in a
      <code class="literal">List&lt;Move&gt;</code>, it does not support <code class="literal">cacheType</code>
      <code class="literal">JUST_IN_TIME</code>. Therefore, <code class="literal">moveListFactory</code> uses <code class="literal">cacheType</code>
      <code class="literal">STEP</code> by default and it scales badly in memory footprint.</p></div><div class="section" title="7.7.5. MoveIteratorFactory: Generate Custom Moves Just in Time"><div class="titlepage"><div><div><h3 class="title"><a id="moveIteratorFactory"/>7.7.5. <code class="literal">MoveIteratorFactory</code>: Generate Custom Moves Just in Time</h3></div></div></div><p>Use this advanced form to generate custom moves by implementing the <code class="literal">MoveIteratorFactory</code>
      interface:</p><pre><code class="language-java">public interface MoveIteratorFactory {

    long getSize(ScoreDirector scoreDirector);

    Iterator&lt;Move&gt; createOriginalMoveIterator(ScoreDirector scoreDirector);

    Iterator&lt;Move&gt; createRandomMoveIterator(ScoreDirector scoreDirector, Random workingRandom);

}</code></pre><p>The <code class="literal">getSize()</code> method must give an estimation of the size. It doesn't need to be correct.
      The <code class="literal">createOriginalMoveIterator</code> method is called if the <code class="literal">selectionOrder</code> is
      <code class="literal">ORIGINAL</code> or if it is cached. The <code class="literal">createRandomMoveIterator</code> method is called
      for <code class="literal">selectionOrder</code> <code class="literal">RANDOM</code> combined with cacheType
      <code class="literal">JUST_IN_TIME</code>.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>Don't create a collection (list, array, map, set) of <code class="literal">Move</code>s when creating the
        <code class="literal">Iterator&lt;Move&gt;</code>: the whole purpose of <code class="literal">MoveIteratorFactory</code> over
        <code class="literal">MoveListFactory</code> is giving you the ability to create a <code class="literal">Move</code> just in time in
        the <code class="literal">Iterator</code>'s method <code class="literal">next()</code>.</p></div><p>Simple configuration (which can be nested in a <code class="literal">unionMoveSelector</code> just like any other
      <code class="literal">MoveSelector</code>):</p><pre><code class="language-xml">    &lt;moveIteratorFactory&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
    &lt;/moveIteratorFactory&gt;</code></pre><p>Advanced configuration:</p><pre><code class="language-xml">    &lt;moveIteratorFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
    &lt;/moveIteratorFactory&gt;</code></pre></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><script type="text/javascript">
dataLayer = [{'channel' : 'OptaPlanner', 'additional_tracking_code' : 'UA-39485370-1'}];
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJWS5L');</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NJWS5L" height="0" width="0" style="display:none;visibility:hidden"> </iframe></noscript><ul class="docnav"><li class="previous"><a accesskey="p" href="ch06.html"><strong>Prev</strong>Chapter 6. Optimization Algorithms</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch08.html"><strong>Next</strong>Chapter 8. Exhaustive Search</a></li></ul></body></html>